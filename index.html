<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CracTrac - Crack Inspection App (Offline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDK using compat versions -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>
  <!-- Dexie.js for IndexedDB -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
  <!-- JSZip for export functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <!-- jsPDF for PDF report generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas for capturing HTML as image -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // Mobile detection for mobile-optimized view (unchanged)
    document.addEventListener("DOMContentLoaded", function () {
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.body.classList.add("mobile");
        const banner = document.createElement("div");
        banner.className = "mobile-banner";
        banner.textContent = "Mobile optimized view activated.";
        document.body.insertBefore(banner, document.body.firstChild);
      }
    });
  </script>
</head>
<body>
  <header>
    <h1>CracTrac - Crack Inspection App (Offline)</h1>
  </header>
  <main id="main-content">
    <!-- Dashboard with general GA, equipment list, summary, and data import/export/report buttons -->
    <section id="dashboard">
      <h2>Site Overview</h2>
      <img src="images/site_overview.jpg" alt="Site Overview" id="siteOverview">
      <div id="equipmentList">
        <h3>Select Equipment</h3>
        <ul>
          <li><button class="equipment-button" data-equipment-id="223-CH-308">223-CH-308</button></li>
          <li><button class="equipment-button" data-equipment-id="223-CH-306">223-CH-306</button></li>
          <li><button class="equipment-button" data-equipment-id="224-CH326">224-CH326</button></li>
          <li><button class="equipment-button" data-equipment-id="224-CH-328">224-CH-328</button></li>
        </ul>
      </div>
      <div id="summary">
        <h3>Summary</h3>
        <div id="summaryContent">
          <!-- Summary content generated by app.js -->
        </div>
      </div>
      <!-- Data Import/Export/Report Section -->
      <div id="dataSection">
        <input type="file" id="importFileInput" accept="application/json">
        <button id="importData">Import Data</button>
        <button id="exportData">Export Data</button>
        <button id="generateReport">Generate Report</button>
      </div>
    </section>
    
    <!-- Equipment Detail Page -->
    <section id="equipmentDetail" style="display:none;">
      <button id="backToDashboard">Back to Dashboard</button>
      <h2 id="equipmentTitle"></h2>
      <div id="drawingContainer" style="position: relative;">
        <img id="equipmentDrawing" src="" alt="Equipment Drawing">
        <!-- Crack markers will be dynamically added here -->
      </div>
    </section>
    
    <!-- Modal for adding/editing a crack -->
    <div id="crackModal" class="modal">
      <div class="modal-content">
        <span id="closeCrackModal" class="close">&times;</span>
        <div id="crackModalBody">
          <!-- Dynamic form content -->
        </div>
      </div>
    </div>
    
    <!-- Modal for editing summary (if needed) -->
    <div id="summaryModal" class="modal">
      <div class="modal-content">
        <span id="closeSummaryModal" class="close">&times;</span>
        <div id="summaryModalBody">
          <!-- Dynamic summary edit content -->
        </div>
      </div>
    </div>
    
    <!-- Instructions Section -->
    <section id="instructions">
      <h2>How to Use CracTrac</h2>
      <p>
        <strong>Working Offline:</strong> Use the app on your mobile device or desktop. Tap an equipment ID to view its detailed drawing, then tap on the drawing to add a crack (photo, note, severity). Markers are placed in the correct position based on the imageâ€™s intrinsic dimensions.
      </p>
      <p>
        <strong>Export/Import:</strong> In the dashboard, click <em>Export Data</em> to download a ZIP file containing your data as JSON. Later, use <em>Import Data</em> to load that file on your desktop.
      </p>
      <p>
        <strong>Generate Report:</strong> Click <em>Generate Report</em> to produce a PDF report for each equipment. The report shows the annotated equipment drawing with markers (each labeled with its crack name and location) and lists all cracks with their photo, note, and severity. Once generated, a download link will appear.
      </p>
    </section>
  </main>
  
  <!-- Include JS files -->
  <script src="firebase.js"></script>
  <script src="db.js"></script>
  <script src="app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    }
  </script>
</body>
</html>
